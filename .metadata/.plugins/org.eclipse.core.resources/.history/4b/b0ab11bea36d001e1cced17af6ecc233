<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.reservation">
	<insert id="insertReservation" parameterType="Reservation"
		useGeneratedKeys="true" keyProperty="id">
    <![CDATA[
       insert into Reservation (pidnum,comnum,resdate,restime,comment,status,doccomment) values 
       (#{pidnum},#{comnum},#{resdate},#{restime},#{comment},#{status},#{doccomment}) 
    ]]>
	</insert>

	<select id="cntMyReservation" parameterType="String" resultType="Integer">
	<![CDATA[
		SELECT COUNT(p.pidnum)
		FROM reservation r,
		hospital h,
		patient p
		WHERE 1=1
		AND r.pidnum = #{pidnum}
		AND r.comnum = h.comnum
		]]>
	</select>

    <!-- 내 예약 목록 조회_박행복 -->
	<select id='selectMyReservation' parameterType="String" resultType="hashmap">
   <![CDATA[
   select h.hname as name
        , h.hroad as address
        , h.htel as tel
        , r.resdate as date
        , r.restime as time
        , r.`status` as status
        , r.id as id
        , r.fidnum as fidnum
    from reservation r
       , hospital h
   where 1=1
     and r.pidnum = #{pidnum}
     and r.comnum = h.comnum
order by r.resdate desc
     ]]>   
	</select>
	
	

	<!-- 리뷰 번호로 예약자 주민 번호 찾기_박행복 -->
	<select id="findById" parameterType="Integer" resultType="String">
	<![CDATA[
	SELECT r.fidnum
	  FROM reservation r
	 WHERE 1=1
	   AND r.id = #{id};
 ]]>
     </select>
	
	
     <!-- 예약 세부 내용 조회 - 본인_박행복 -->
	 <select id="selectMyDetailReservation" parameterType="hashMap" resultType="hashmap">
	 <![CDATA[
     SELECT h.hname as hname
	      , h.hroad as address
	      , h.clinic as time
	      , h.htel as tel
	      , p.pname as pname
	      , r.resdate as resdate
	      , r.restime as restime
	      , h.department as department
	      , r.comment as comment
	      , p.pidnum  
	      , r.status as status
	      , r.id as id
	   FROM hospital h
	      , patient p
	      , reservation r
	  WHERE 1=1
	    AND p.pidnum = r.pidnum
		AND h.comnum = r.comnum
	    AND r.pidnum = #{pidnum}
	    AND r.id     = #{id}
	    ]]>
     </select>
	
	
	<!-- 예약 세부 내용 조회 - 가족_박행복 -->
	 <select id="selectFamDetailReservation" parameterType="hashMap" resultType="hashmap">
	 <![CDATA[
     SELECT h.hname as hname
	      , h.hroad as address
	      , h.clinic as time
	      , h.htel as tel
	      , f.fname as pname
	      , r.resdate as resdate
	      , r.restime as restime
	      , h.department as department
	      , r.comment as comment
	      , r.status as status
	      , r.id as id
	   FROM hospital h
	      , reservation r
	      , family f
	  WHERE 1=1
	    AND f.fidnum = r.fidnum
	    AND h.comnum = r.comnum
	    AND f.pidnum = #{pidnum}
	    AND r.id = #{id}
	    ]]>
     </select>
     
     
     <!-- 예약 취소_박행복 -->
     <update id="statusUpdate" parameterType="Reservation">
     <![CDATA[
     update reservation set status = #{status} where id = #{id}
     ]]>
     </update>
	
	<!-- comment 수정 -->
	<update id="commentUpdate" parameterType="Reservation">
     <![CDATA[
     update reservation set comment = #{comment} where id = #{id}
     ]]>
     </update>
	
	
	<select id='selectTodayReservationList' parameterType="Integer" resultType="Reservation">
	<![CDATA[
		select id,resdate,restime,p.pname,p.pidnum,comment,h.department,status
		from reservation r,patient p,hospital h
		where r.pidnum=p.pidnum
		and h.comnum=r.comnum
		order by id desc
		limit #{row},10
	]]>
	</select>
	<select id='selectHRecordList' parameterType="String" resultType="Reservation">
	<![CDATA[
		select resdate,restime,p.pname,comment,h.department,status,doccomment
		from reservation r,patient p,hospital h
		where r.pidnum=p,pidnum
		and h.comnum=r.comnum
		order by resdate desc
		limit #{row},10
	]]>
	</select>
	
	<select id='selectReservation' parameterType="Integer" resultType="Reservation">
	<![CDATA[
		select * from reservation where id=#{id}
	]]>
	</select>
	
	

	<select id='searchHRecordList' parameterType="hashmap" resultType="Reservation">
	<![CDATA[
		select * from reservation
   		where ${type} like '%${keyword}%' order by resdate desc
   		limit #{row},10
	]]>
	
	</select>
	
	<select id='searchHRecordCount' parameterType="hashmap" resultType="Integer">
	<![CDATA[
		select count(*) from reservation
   		where ${type} like '%${keyword}%' 
	]]>
	
	</select>
	
	<select id='searchResTimeList' parameterType="hashmap" resultType="String">
	<![CDATA[
		select restime from reservation
   		where comnum= #{comnum} and resdate=#{date}
	]]>
	
	</select>
	
	<select id="selectAllResBycomnum" parameterType="String" resultType="Reservation">
	<![CDATA[
		SELECT *
		FROM reservation
		WHERE comnum=#{comnum}
		]]>
	</select>
	
	<select id="selectResCount" parameterType="String" resultType="Integer">
      <![CDATA[
         select count(pidnum) from reservation where comnum=#{comnum}
      ]]>
    
   </select>
   
 	<!-- 전체 예약조회 -->
	<select id="searchAllResCount" parameterType="hashmap" resultType="Integer">
      <![CDATA[
         select count(pidnum) from reservation 
         where comnum=#{comnum} and resdate between #{sdate} and #{edate} and ${type} like '%${keyword}%'
      ]]>
    
   </select>
   
   <select id='searchAllResList' parameterType="hashmap" resultType="Reservation">
	<![CDATA[
		select * from reservation 
        where comnum=#{comnum} and resdate between #{sdate} and #{edate} and ${type} like '%${keyword}%'
        limit #{row},10
	]]>
	</select>
	
	<!-- 예약 환자 조건 검색 데이터 수-->
	<select id="searchReservationCount"  resultType="Integer" parameterType="hashmap" >
		<![CDATA[
			select count(*) 
		 	from reservation r, patient p
	 		where r.pidnum=p.pidnum	and p.${type} = #{keyword}
		]]>
	</select>
	
	<!-- 예약 환자 조건 검색 -->
	<select id='searchReservationList' parameterType="hashmap" resultType="hashmap">
	 <![CDATA[
	 	select p.pname as pname,p.pidnum as pidnum,p.pemail as pemail,p.ptel as ptel, 
	 		p.ppostcode as ppostcode,p.proadaddress as proadaddress 
	 	from reservation r, patient p
	 	where r.pidnum=p.pidnum	and p.${type} = #{keyword}
	 	order by id desc
	 	limit #{row},10
	 ]]>
	 </select> 
	 
	 
	<!-- 예약 환자 전체 데이터 수-->
	<select id='selectAllReservationCount' resultType="Integer">
	<![CDATA[
		select count(*) from reservation
	]]>
	</select>
	
	<!-- 예약 환자 전체 조회 -->
	<select id='selectAllReservationList' parameterType="Integer" resultType="hashmap">
	 	select p.pname as pname,p.pidnum as pidnum,p.pemail as pemail,p.ptel as ptel, 
	 		p.ppostcode as ppostcode,p.proadaddress as proadaddress 
	 	from reservation r, patient p
	 	where r.pidnum=p.pidnum
	 	order by id desc
	 	limit #{row},10
	</select>


</mapper>